<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Subscription Calibration ‚Äî Zama FHEVM</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 30% 20%, #1f2937, #0a0a0a);
      --card-bg: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.15);
      --text: #f3f4f6;
      --accent: #38bdf8;
      --accent2: #a78bfa;
      --radius: 20px;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; padding: 40px; }
    .container { max-width: 1100px; margin: auto; display: flex; flex-direction: column; gap: 30px; }
    header { display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 1.8rem; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; color: transparent; }
    .btn { border: none; border-radius: var(--radius); padding: 12px 20px; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; transition: all 0.25s; }
    .btn:hover { filter: brightness(1.15); transform: translateY(-2px); }
    .card { backdrop-filter: blur(12px); background: var(--card-bg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 28px; box-shadow: 0 4px 25px rgba(0,0,0,0.25); }
    label { display: block; margin-top: 12px; font-weight: 600; font-size: 14px; color: #cbd5e1; }
    input { width: 100%; margin-top: 6px; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06); color: var(--text); font-size: 15px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    pre { background: rgba(255,255,255,0.06); border: 1px dashed var(--border); border-radius: 12px; padding: 10px; overflow:auto; }
    footer { text-align: center; color: #9ca3af; font-size: 13px; margin-top: 40px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîê Private Subscription Calibration</h1>
      <button id="btnConnect" class="btn">Connect Wallet</button>
    </header>

    <section class="card">
      <h2>1Ô∏è‚É£ Submit Encrypted Preferences</h2>
      <label>Duration (1‚Äì12 months)</label>
      <input id="inpDuration" type="number" min="1" max="12" value="6"/>
      <label>Budget ($)</label>
      <input id="inpBudget" type="number" min="0" max="1000" value="500"/>
      <label>Content Type (0=general,1=music,2=video,3=games)</label>
      <input id="inpContent" type="number" min="0" max="3" value="2"/>
      <div class="row">
        <button id="btnSubmit" class="btn">Encrypt & Send</button>
        <div id="status" style="font-size:14px;color:#9ca3af;"></div>
      </div>
    </section>

    <section class="card">
      <h2>2Ô∏è‚É£ Retrieve & Decrypt Plan</h2>
      <label>Profile ID</label>
      <input id="inpId" type="number" min="1" value="1"/>
      <div class="row">
        <button id="btnHandle" class="btn">Get Plan Handle</button>
        <button id="btnDecrypt" class="btn">Public Decrypt</button>
      </div>
      <pre id="output">‚Äî</pre>
    </section>

    <footer>Built with ‚ù§Ô∏è & Zama FHEVM ¬∑ Relayer SDK 0.2.0 ¬∑ Ethers v6</footer>
  </div>

  <script type="module">
    import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    const CONFIG = {
      RELAYER_URL: "https://relayer.testnet.zama.cloud",
      CONTRACT_ADDRESS: "0x926811cb8899A50faC16042B7fa2A686252E85DD"
    };

    const ABI = [
      "function submitPreferences(bytes32,bytes32,bytes32,bytes) external returns (uint256)",
      "function planHandle(uint256) external view returns (bytes32)",
      "function makePlanPublic(uint256) external",
    ];

    let provider, signer, address, contract, relayer;
    const $ = s => document.querySelector(s);
    const toHex = u8 => '0x' + Array.from(u8, b => b.toString(16).padStart(2,'0')).join('');

    async function connect() {
      provider = new BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();
      contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);
      $("#btnConnect").textContent = address.slice(0,6)+"‚Ä¶"+address.slice(-4);
      if (!relayer) {
        await initSDK();
        relayer = await createInstance({
          ...SepoliaConfig,
          relayerUrl: CONFIG.RELAYER_URL,
          network: window.ethereum
        });
      }
    }

    $("#btnConnect").onclick = connect;

    $("#btnSubmit").onclick = async () => {
      try {
        await connect();
        const duration = parseInt($("#inpDuration").value);
        const budget = parseInt($("#inpBudget").value);
        const content = parseInt($("#inpContent").value);
        $("#status").textContent = "Encrypting‚Ä¶";

        const enc = relayer.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
        enc.add8(BigInt(duration));
        enc.add16(BigInt(budget));
        enc.add8(BigInt(content));
        const { handles, inputProof } = await enc.encrypt();

        // Correctly extract handles and proof
        const h1 = handles[0]?.handle || handles[0]?.ciphertext || handles[0];
        const h2 = handles[1]?.handle || handles[1]?.ciphertext || handles[1];
        const h3 = handles[2]?.handle || handles[2]?.ciphertext || handles[2];
        const att = typeof inputProof === "string" ? (inputProof.startsWith("0x") ? inputProof : "0x" + inputProof) : toHex(inputProof);

        console.log("üîπ Submit args:", { h1, h2, h3, att });

        const tx = await contract.submitPreferences(h1, h2, h3, att);
        $("#status").textContent = "Tx sent‚Ä¶";
        await tx.wait();
        $("#status").textContent = "Submitted successfully ‚úÖ";
      } catch (e) {
        console.error(e);
        $("#status").textContent = "Error: " + (e.message || e);
      }
    };

    $("#btnHandle").onclick = async () => {
      try {
        const id = parseInt($("#inpId").value);
        const handle = await contract.planHandle(id);
        $("#output").textContent = "Encrypted Plan Handle:\n" + handle;
      } catch (e) {
        $("#output").textContent = "Error: " + e.message;
      }
    };

    // $("#btnDecrypt").onclick = async () => {
    //   try {
    //     const handle = $("#output").textContent.split("\n")[1]?.trim();
    //     if (!handle || handle === "‚Äî") throw new Error("Get handle first");
    //     const result = await relayer.publicDecrypt([handle]);
    //     console.log("üîπ Decrypt result:", result);
    //     const val = Number(result[handle]);
    //     const plan = ["Basic", "Standard", "Premium"][val] || "Unknown";
    //     $("#output").textContent += `\nDecrypted Plan: ${plan}`;
    //   } catch (e) {
    //     $("#output").textContent = "Decrypt error: " + (e.message || e);
    //   }
    // };

    $("#btnDecrypt").onclick = async () => {
  try {
    const id = parseInt($("#inpId").value);
    const handle = $("#output").textContent.split("\n")[1]?.trim();
    if (!handle || handle === "‚Äî") throw new Error("Get handle first");

    // 1Ô∏è‚É£ make plan public
    const tx = await contract.makePlanPublic(id);
    $("#output").textContent += "\nMaking plan public‚Ä¶";
    await tx.wait();

    // 2Ô∏è‚É£ then decrypt
    const result = await relayer.publicDecrypt([handle]);
    console.log("üîπ Decrypt result:", result);
    const val = Number(result[handle]);
    const plan = ["Basic", "Standard", "Premium"][val] || "Unknown";
    $("#output").textContent += `\nDecrypted Plan: ${plan}`;
  } catch (e) {
    console.error(e);
    $("#output").textContent = "Decrypt error: " + (e.message || e);
  }
};

  </script>
</body>
</html>
